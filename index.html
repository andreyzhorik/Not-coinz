<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Spin the Wheel ‚Äî VIP</title>
<style>
  :root {
    --bg: #0f0f18;
    --panel-bg: #0b0b11;
    --white: #ffffff;
    --yellow: #f1c40f;
    --purple: #4819b6;
    --green: #2ecc71;
    --red: #e74c3c;
    --blue: #3498db;
  }
  body {
    font-family: 'Segoe UI', Arial, sans-serif;
    background: var(--bg);
    color: var(--white);
    margin: 0;
    padding: 20px;
    display: flex;
    gap: 20px;
    align-items: flex-start;
    justify-content: center;
  }
  /* Game column */
  .game {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    width: 500px;
  }
  .wheel-container {
    position: relative;
    width: 400px;
    height: 400px;
  }
  #arrow {
    position: absolute;
    left: 50%;
    top: -20px;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 18px solid transparent;
    border-right: 18px solid transparent;
    border-top: 30px solid red;
    z-index: 10;
  }
  canvas {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    border: 8px solid #fff;
    background: transparent;
    display: block;
  }
  #userinfo {
    font-weight: 700;
    font-size: 18px;
  }
  #controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    width: 100%;
    background: rgba(255,255,255,0.03);
    padding: 12px;
    border-radius: 8px;
  }
  input, select, button {
    font-family: inherit;
    font-size: 14px;
  }
  #username { padding:8px; width:180px; text-align:center; border-radius:6px; border:1px solid #333; background:transparent; color:white; }
  #setUsername { padding:8px 12px; border-radius:6px; cursor:pointer; background:#2d8aee; color:white; border:none; }
  #bet { padding:8px; width:120px; text-align:center; border-radius:6px; border:1px solid #333; background:transparent; color:white; }
  #spin { padding:10px 18px; background:#28a745; border-radius:8px; color:white; border:none; cursor:pointer; font-weight:700; }
  #spin:disabled { opacity:0.5; cursor:not-allowed; }
  /* Admin panel */
  #adminPanel { margin-top:10px; width:100%; background: rgba(0,0,0,0.25); padding:10px; border-radius:8px; color:white; }
  .admin-controls { margin-top:8px; display:none; flex-direction:column; gap:8px; }
  .admin-controls input, .admin-controls select, .admin-controls button { padding:6px; border-radius:6px; }
  /* Leaderboard column */
  .side {
    width: 300px;
    background: rgba(255,255,255,0.03);
    padding:12px;
    border-radius:8px;
  }
  .side h2 { margin:0 0 8px 0; }
  #leaderboardList { list-style:none; padding-left:0; margin:0; max-height:520px; overflow:auto; }
  #leaderboardList li { padding:6px 6px; border-bottom:1px solid rgba(255,255,255,0.03); font-weight:600; }
  .row { display:flex; gap:8px; align-items:center; }
  .muted { color:rgba(255,255,255,0.6); font-size:13px; }
</style>
</head>
<body>

<div class="game">
  <h1>üé° Spin the Wheel</h1>
  <div class="wheel-container">
    <div id="arrow"></div>
    <canvas id="wheel" width="400" height="400"></canvas>
  </div>
  <div id="userinfo">Not logged in</div>
  <div id="controls">
    <div class="row">
      <input id="username" type="text" placeholder="Enter username (once)">
      <button id="setUsername">Set Username</button>
    </div>
    <div class="row">
      <label class="muted">Bet:</label>
      <input id="bet" type="number" min="1" value="10">
      <button id="spin">SPIN</button>
    </div>
    <div id="adminPanel">
      <div class="row">
        <label class="muted">Admin pass:</label>
        <input id="adminPass" type="password" placeholder="Password">
        <button id="adminBtn">Enter</button>
      </div>
      <div class="admin-controls" id="adminControls">
        <div class="row">
          <label class="muted">Set coins:</label>
          <input id="adminCoins" type="number" min="0" value="100">
          <button id="setCoinsBtn">Set</button>
          <button id="resetUserCoinsBtn">Reset User Coins</button>
        </div>
        <div class="row">
          <label class="muted">Set rank:</label>
          <select id="adminRank">
            <option value="None">None</option>
            <option value="VIP">VIP</option>
            <option value="VIP+">VIP+</option>
            <option value="VIP++">VIP++</option>
          </select>
          <button id="setRankBtn">Set Rank</button>
        </div>
        <div class="row">
          <button id="resetLeaderboardBtn" style="background:#e74c3c;color:white;">Reset Leaderboard</button>
          <button id="hideAdminBtn">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="side">
  <h2>üèÜ Leaderboard</h2>
  <ul id="leaderboardList"></ul>
</div>

<script>
/* ---------------- CONFIG & DOM ---------------- */
const canvas = document.getElementById('wheel');
const ctx = canvas.getContext('2d');
const spinBtn = document.getElementById('spin');
const setUsernameBtn = document.getElementById('setUsername');
const usernameInput = document.getElementById('username');
const coinInfo = document.getElementById('userinfo');
const betInput = document.getElementById('bet');

const outcomes = [
  "1.5x","0.5x","0.5x","1.1x","1.8x","10x","1.9x","Lose","Lose","1.7x",
  "Lose","1x","Lose","1x","Lose","Lose","1.4x","Lose","Lose","1.2x",
  "Lose","Lose","2.0x","5.0x","2.5x","1.3x","Lose","1.6x","0.5x","Lose",
  "2.5x","Lose","0.75x","Lose","2.0x","Lose"
];
const colors = outcomes.map(o => {
    if(o==="Lose"||o==="0.5x"||o==="0.75x") return "#e74c3c";
    if(o==="5.0x"||o==="10x") return "#2ecc71";
    return "#3498db";
});

const N = outcomes.length;
const sliceDeg = 360 / N;
const RAD = Math.PI/180;
let rotationDeg = 0;
let spinning = false;

/* -------- STATE -------- */
let username = "";
let coins = 100;
let rank = "None";
const API_URL = "https://68e839b2f2707e6128ca35e1.mockapi.io/players";

/* ---------------- FUNCTIONS ---------------- */
function drawWheel(rotDeg){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.save();
    const cx = canvas.width/2, cy = canvas.height/2;
    const radius = canvas.width/2 - 10;
    ctx.translate(cx,cy);
    ctx.rotate((rotDeg-90)*RAD);
    const slice = 2*Math.PI/N;
    for(let i=0;i<N;i++){
        const angle=i*slice;
        ctx.beginPath();
        ctx.moveTo(0,0);
        ctx.arc(0,0,radius,angle,angle+slice);
        ctx.closePath();
        ctx.fillStyle=colors[i];
        ctx.fill();
        ctx.strokeStyle="#111"; ctx.lineWidth=2; ctx.stroke();
        ctx.save();
        ctx.rotate(angle+slice/2);
        ctx.translate(radius*0.7,0);
        ctx.rotate(Math.PI/2);
        ctx.fillStyle="white";
        ctx.font="bold 14px Arial";
        ctx.textAlign="center"; ctx.textBaseline="middle";
        ctx.fillText(outcomes[i],0,0);
        ctx.restore();
    }
    ctx.restore();
}
drawWheel(rotationDeg);

function updateUserInfoDisplay(){
    if(!username){ coinInfo.textContent="Not logged in"; coinInfo.style.color="white"; return; }
    coinInfo.textContent = `${username}: ${coins} | ${rank}`;
    if(rank==="VIP"||rank==="VIP+") coinInfo.style.color="var(--yellow)";
    else if(rank==="VIP++") coinInfo.style.color="var(--purple)";
    else coinInfo.style.color="white";
}

/* -------- SERVER FUNCTIONS -------- */
async function fetchLeaderboard() {
    try {
        const res = await fetch(API_URL);
        return await res.json();
    } catch(e) { console.error("Fetch error:", e); return []; }
}

async function updatePlayerServer(player) {
    try {
        const board = await fetchLeaderboard();
        const existing = board.find(p=>p.name===player.name);
        if(existing){
            await fetch(`${API_URL}/${existing.id}`, {
                method:"PUT",
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify(player)
            });
        } else {
            await fetch(API_URL,{
                method:"POST",
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify(player)
            });
        }
    } catch(e){ console.error("Update error:", e); }
}

async function saveCurrentToServer(){
    if(!username) return;
    await updatePlayerServer({name:username, coins, rank});
    await renderLeaderboard();
}

async function getUserFromServer(name){
    const list = await fetchLeaderboard();
    return list.find(p=>p.name===name);
}

async function renderLeaderboard(){
    const ul = document.getElementById('leaderboardList');
    ul.innerHTML="";
    const list = await fetchLeaderboard();
    list.sort((a,b)=>b.coins-a.coins);
    list.slice(0,20).forEach((p,i)=>{
        const li=document.createElement('li');
        let color="white";
        if(p.rank==="VIP"||p.rank==="VIP+") color="var(--yellow)";
        else if(p.rank==="VIP++") color="var(--purple)";
        li.style.color=color;
        li.textContent = `${i+1}. ${p.name}: ${p.coins} | ${p.rank || "None"}`;
        ul.appendChild(li);
    });
}

/* -------- USER LOGIN -------- */
setUsernameBtn.addEventListener('click', async ()=>{
    const val = usernameInput.value.trim();
    if(!val){ alert("Enter a username"); return; }
    username = val;
    usernameInput.disabled = true;
    setUsernameBtn.disabled = true;

    const user = await getUserFromServer(username);
    if(user){
        coins = user.coins;
        rank = user.rank || "None";
    } else {
        coins = 100;
        rank = "None";
        await saveCurrentToServer();
    }
    updateUserInfoDisplay();
    renderLeaderboard();
});

/* -------- SPIN OVERRIDE -------- */
spinBtn.addEventListener('click', async ()=>{
    if(!username){ alert("Set username first"); return; }
    if(spinning) return;
    let bet = Math.floor(Number(betInput.value)||0);
    if(!bet||bet<=0){ alert("Enter valid bet"); return; }
    if(bet>coins){ alert("Not enough coins"); return; }

    coins = Math.max(0, coins-bet);
    updateUserInfoDisplay();
    spinning = true;

    const idx = Math.floor(Math.random()*N);
    const result = outcomes[idx];
    const currentNorm = ((rotationDeg%360)+360)%360;
    const sliceCenterDeg = idx*sliceDeg + sliceDeg/2;
    const baseRotationDeg = (360 - sliceCenterDeg) % 360;
    const delta = (baseRotationDeg - currentNorm + 360) % 360;
    const fullSpins = 6 + Math.floor(Math.random()*5);
    const targetRotation = rotationDeg + fullSpins*360 + delta;
    const start = rotationDeg;
    const duration = 4200;
    const t0 = performance.now();

   function step(t){
    const elapsed = t - t0;
    const p = Math.min(elapsed/duration,1);
    const ease = 1 - Math.pow(1-p,3);
    rotationDeg = start + (targetRotation-start)*ease;
    drawWheel(rotationDeg);

    if(p<1) requestAnimationFrame(step);
    else{
        rotationDeg = baseRotationDeg + 360*Math.floor(rotationDeg/360);
        let win = 0;
        if(result!=="Lose"){
            const mult = parseFloat(result.replace("x",""));
            if(!Number.isNaN(mult)) win = Math.floor(bet*mult);
            alert(`üéâ You won ${win} coins! (${result})`);
        } else alert("üò¢ You lost your bet!");

        coins = Math.max(0, coins + win);
        if(coins===0) coins = 100;

        // Save coins asynchronously without breaking animation
        saveCurrentToServer();

        updateUserInfoDisplay();
        spinning = false;
    }
}
    requestAnimationFrame(step);
});

/* -------- AUTO-SAVE EVERY 5 SECONDS -------- */
setInterval(()=>{
    if(username) saveCurrentToServer();
}, 5000);

/* -------- INIT -------- */
renderLeaderboard();
updateUserInfoDisplay();

</script>
</body>
</html>
