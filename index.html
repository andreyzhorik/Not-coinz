<!-- Part 1: Wheel + UI -->
<div class="game">
  <h1>üé° Spin the Wheel</h1>
  <div class="wheel-container">
    <div id="arrow"></div>
    <canvas id="wheel" width="400" height="400"></canvas>
  </div>
  <div id="userinfo">Not logged in</div>

  <div id="controls">
    <div class="row">
      <input id="username" type="text" placeholder="Enter username (once)">
      <button id="setUsername">Set Username</button>
    </div>
    <div class="row">
      <label class="muted">Bet:</label>
      <input id="bet" type="number" min="1" value="10">
      <button id="spin">SPIN</button>
    </div>
  </div>
</div>

<div class="side">
  <h2>üèÜ Leaderboard</h2>
  <ul id="leaderboardList"></ul>
</div>

<script>
// ---------------- CONFIG ----------------
const outcomes = ["1.5x","0.5x","0.75x","1x","1.8x","10x","Lose","2.0x","5.0x"];
const colors   = ["#3498db","#e74c3c","#e74c3c","#3498db","#f1c40f","#2ecc71","#e74c3c","#2ecc71","#27ae60"];
const N = outcomes.length;
const sliceDeg = 360 / N;

// ---------------- DOM ----------------
const canvas = document.getElementById('wheel');
const ctx = canvas.getContext('2d');
const cx = canvas.width/2, cy = canvas.height/2, radius = canvas.width/2-10;

const spinBtn = document.getElementById('spin');
const usernameInput = document.getElementById('username');
const setUsernameBtn = document.getElementById('setUsername');
const coinInfo = document.getElementById('userinfo');
const betInput = document.getElementById('bet');
const leaderboardUl = document.getElementById('leaderboardList');

// ---------------- STATE ----------------
let username = "";
let coins = 100;
let rotationDeg = 0;
let spinning = false;

// ---------------- WHEEL DRAW ----------------
function drawWheel(rotDeg){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.save();
  ctx.translate(cx, cy);
  ctx.rotate((rotDeg - 90) * Math.PI / 180);

  const slice = 2*Math.PI / N;
  for(let i=0;i<N;i++){
    const angle = i*slice;
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.arc(0,0,radius,angle,angle+slice);
    ctx.closePath();
    ctx.fillStyle = colors[i];
    ctx.fill();
    ctx.strokeStyle = "#111";
    ctx.lineWidth = 2;
    ctx.stroke();

    ctx.save();
    ctx.rotate(angle+slice/2);
    ctx.translate(radius*0.7,0);
    ctx.rotate(Math.PI/2);
    ctx.fillStyle = "#fff";
    ctx.font = "bold 14px Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(outcomes[i],0,0);
    ctx.restore();
  }
  ctx.restore();
}

// ---------------- USER INFO ----------------
function updateUserInfo(){
  if(!username){
    coinInfo.textContent = "Not logged in";
    return;
  }
  coinInfo.textContent = `${username}: ${coins} coins`;
}

// ---------------- USERNAME ----------------
setUsernameBtn.addEventListener('click',()=>{
  const val=usernameInput.value.trim();
  if(!val){ alert("Enter username"); return; }
  username=val;
  usernameInput.disabled=true;
  setUsernameBtn.disabled=true;
  coins=100;
  updateUserInfo();
  renderLeaderboard();
});

// ---------------- LEADERBOARD ----------------
function renderLeaderboard(){
  leaderboardUl.innerHTML = "";
  const li = document.createElement('li');
  li.textContent = `${username}: ${coins} coins`;
  leaderboardUl.appendChild(li);
}

// ---------------- SPIN ----------------
spinBtn.addEventListener('click',()=>{
  if(!username){ alert("Set username first"); return; }
  if(spinning) return;

  let bet = Math.floor(Number(betInput.value)||0);
  if(!bet || bet <=0){ alert("Enter valid bet"); return; }
  if(bet>coins){ alert("Not enough coins"); return; }

  coins = Math.max(0, coins - bet);
  updateUserInfo();
  spinning = true;

  const idx = Math.floor(Math.random()*N);
  const result = outcomes[idx];

  const currentNorm = ((rotationDeg%360)+360)%360;
  const sliceCenterDeg = idx*sliceDeg + sliceDeg/2;
  const baseRotationDeg = (360 - sliceCenterDeg) % 360;
  const delta = (baseRotationDeg - currentNorm + 360)%360;
  const fullSpins = 6 + Math.floor(Math.random()*5);
  const targetRotation = rotationDeg + fullSpins*360 + delta;

  const start = rotationDeg;
  const duration = 4000;
  const t0 = performance.now();

  function step(t){
    const elapsed = t-t0;
    const p = Math.min(elapsed/duration,1);
    const ease = 1-Math.pow(1-p,3);
    rotationDeg = start + (targetRotation-start)*ease;
    drawWheel(rotationDeg);
    if(p<1) requestAnimationFrame(step);
    else {
      rotationDeg = baseRotationDeg + 360*Math.floor(rotationDeg/360);
      let win = 0;
      if(result !== "Lose"){
        const mult = parseFloat(result.replace("x",""));
        win = Math.floor(bet*mult);
        alert(`üéâ You won ${win} coins! (${result})`);
      } else {
        alert("üò¢ You lost your bet!");
      }
      coins = Math.max(0, coins + win);
      if(coins===0) coins=100;
      updateUserInfo();
      renderLeaderboard();
      spinning=false;
    }
  }
  requestAnimationFrame(step);
});

// initial draw
drawWheel(rotationDeg);
</script>
<script>
// ---------------- CONFIG ----------------
const API_URL = "https://68e839b2f2707e6128ca35e1.mockapi.io/players"; // your mock API
const ADMIN_PASSWORD = "ghd87";

// ---------------- DOM ----------------
const leaderboardUl = document.getElementById('leaderboardList');
const coinInfo = document.getElementById('userinfo');
const usernameInputEl = document.getElementById('username');
const setUsernameBtnEl = document.getElementById('setUsername');

// ---------------- STATE ----------------
let username = "";
let coins = 100;
let rank = "None";

// ---------------- UTILS ----------------
function getRankColor(r){
  if(!r || r==="None") return "#fff";
  if(r==="VIP") return "#f9f37c";
  if(r==="VIP+") return "#f1c40f";
  if(r==="VIP++") return "#4819b6";
  return "#fff";
}

// ---------------- API ----------------
async function fetchLeaderboard(){
  try{
    const res = await fetch(API_URL);
    return await res.json();
  }catch(e){
    console.error("Fetch leaderboard failed", e);
    return [];
  }
}

async function saveUser(){
  if(!username) return;
  try{
    const list = await fetchLeaderboard();
    const existing = list.find(p => p.name===username);
    const payload = { name: username, coins: coins, rank: rank };
    if(existing){
      await fetch(`${API_URL}/${existing.id}`, {
        method:"PUT",
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
    } else {
      await fetch(API_URL, {
        method:"POST",
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
    }
  }catch(e){ console.error("Save user failed", e);}
}

// ---------------- LEADERBOARD ----------------
async function renderLeaderboard(){
  const list = await fetchLeaderboard();
  list.sort((a,b)=>b.coins - a.coins);
  leaderboardUl.innerHTML="";
  list.forEach((p,i)=>{
    const li = document.createElement('li');
    li.style.color = getRankColor(p.rank);
    li.textContent = `${i+1}. ${p.name}: ${p.coins} | ${p.rank || "None"}`;
    leaderboardUl.appendChild(li);
  });
  updateUserInfo();
}

// ---------------- USER INFO ----------------
function updateUserInfo(){
  if(!username){
    coinInfo.textContent = "Not logged in";
    coinInfo.style.color = "#fff";
    return;
  }
  coinInfo.textContent = `${username}: ${coins} | ${rank}`;
  coinInfo.style.color = getRankColor(rank);
}

// ---------------- USERNAME ----------------
setUsernameBtnEl.addEventListener('click', async ()=>{
  const val = usernameInputEl.value.trim();
  if(!val){ alert("Enter username"); return; }
  username = val;
  usernameInputEl.disabled = true;
  setUsernameBtnEl.disabled = true;

  const list = await fetchLeaderboard();
  const existing = list.find(p=>p.name===username);
  if(existing){
    coins = Number(existing.coins)||100;
    rank = existing.rank || "None";
  } else {
    coins = 100;
    rank = "None";
    await saveUser();
  }
  updateUserInfo();
  await renderLeaderboard();
});

// ---------------- POST-SPIN UPDATE ----------------
async function afterSpin(result, bet){
  let win=0;
  if(result!=="Lose"){
    const mult=parseFloat(result.replace("x",""));
    win=Math.floor(bet*mult);
  }
  coins=Math.max(0, coins + win);
  if(coins===0) coins=100;
  updateUserInfo();
  await saveUser();
  await renderLeaderboard();
}
</script>

