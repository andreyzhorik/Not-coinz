<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Spin the Wheel ‚Äî VIP</title>
<style>
  :root {
    --bg: #0f0f18;
    --panel-bg: #0b0b11;
    --white: #ffffff;
    --yellow: #f1c40f;
    --purple: #4819b6;
    --green: #2ecc71;
    --red: #e74c3c;
    --blue: #3498db;
  }
  body {
    font-family: 'Segoe UI', Arial, sans-serif;
    background: var(--bg);
    color: var(--white);
    margin: 0;
    padding: 20px;
    display: flex;
    gap: 20px;
    align-items: flex-start;
    justify-content: center;
  }
  /* Game column */
  .game {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    width: 500px;
  }
  .wheel-container {
    position: relative;
    width: 400px;
    height: 400px;
  }
  #arrow {
    position: absolute;
    left: 50%;
    top: -20px;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 18px solid transparent;
    border-right: 18px solid transparent;
    border-top: 30px solid red;
    z-index: 10;
  }
  canvas {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    border: 8px solid #fff;
    background: transparent;
    display: block;
  }
  #userinfo {
    font-weight: 700;
    font-size: 18px;
  }
  #controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    width: 100%;
    background: rgba(255,255,255,0.03);
    padding: 12px;
    border-radius: 8px;
  }
  input, select, button {
    font-family: inherit;
    font-size: 14px;
  }
  #username { padding:8px; width:180px; text-align:center; border-radius:6px; border:1px solid #333; background:transparent; color:white; }
  #setUsername { padding:8px 12px; border-radius:6px; cursor:pointer; background:#2d8aee; color:white; border:none; }
  #bet { padding:8px; width:120px; text-align:center; border-radius:6px; border:1px solid #333; background:transparent; color:white; }
  #spin { padding:10px 18px; background:#28a745; border-radius:8px; color:white; border:none; cursor:pointer; font-weight:700; }
  #spin:disabled { opacity:0.5; cursor:not-allowed; }
  /* Admin panel */
  #adminPanel { margin-top:10px; width:100%; background: rgba(0,0,0,0.25); padding:10px; border-radius:8px; color:white; }
  .admin-controls { margin-top:8px; display:none; flex-direction:column; gap:8px; }
  .admin-controls input, .admin-controls select, .admin-controls button { padding:6px; border-radius:6px; }
  /* Leaderboard column */
  .side {
    width: 300px;
    background: rgba(255,255,255,0.03);
    padding:12px;
    border-radius:8px;
  }
  .side h2 { margin:0 0 8px 0; }
  #leaderboardList { list-style:none; padding-left:0; margin:0; max-height:520px; overflow:auto; }
  #leaderboardList li { padding:6px 6px; border-bottom:1px solid rgba(255,255,255,0.03); font-weight:600; }
  .row { display:flex; gap:8px; align-items:center; }
  .muted { color:rgba(255,255,255,0.6); font-size:13px; }
</style>
</head>
<body>

<div class="game">
  <h1>üé° Spin the Wheel</h1>
  <div class="wheel-container">
    <div id="arrow"></div>
    <canvas id="wheel" width="400" height="400"></canvas>
  </div>
  <div id="userinfo">Not logged in</div>
  <div id="controls">
    <div class="row">
      <input id="username" type="text" placeholder="Enter username (once)">
      <button id="setUsername">Set Username</button>
    </div>
    <div class="row">
      <label class="muted">Bet:</label>
      <input id="bet" type="number" min="1" value="10">
      <button id="spin">SPIN</button>
    </div>
    <div id="adminPanel">
      <div class="row">
        <label class="muted">Admin pass:</label>
        <input id="adminPass" type="password" placeholder="Password">
        <button id="adminBtn">Enter</button>
      </div>
      <div class="admin-controls" id="adminControls">
        <div class="row">
          <label class="muted">Set coins:</label>
          <input id="adminCoins" type="number" min="0" value="100">
          <button id="setCoinsBtn">Set</button>
          <button id="resetUserCoinsBtn">Reset User Coins</button>
        </div>
        <div class="row">
          <label class="muted">Set rank:</label>
          <select id="adminRank">
            <option value="None">None</option>
            <option value="VIP">VIP</option>
            <option value="VIP+">VIP+</option>
            <option value="VIP++">VIP++</option>
          </select>
          <button id="setRankBtn">Set Rank</button>
        </div>
        <div class="row">
          <button id="resetLeaderboardBtn" style="background:#e74c3c;color:white;">Reset Leaderboard</button>
          <button id="hideAdminBtn">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="side">
  <h2>üèÜ Leaderboard</h2>
  <ul id="leaderboardList"></ul>
</div>

<script>
/* ---------------- CONFIG ---------------- */
const API_URL = "https://68e839b2f2707e6128ca35e1.mockapi.io/players";
const ADMIN_PASSWORD = "ghd87";

/* ---------------- DOM ---------------- */
const leaderboardUl = document.getElementById('leaderboardList');
const coinInfo = document.getElementById('userinfo');
const usernameInputEl = document.getElementById('username');
const setUsernameBtnEl = document.getElementById('setUsername');
const adminPassEl = document.getElementById('adminPass');
const adminBtnEl = document.getElementById('adminBtn');
const adminControlsEl = document.getElementById('adminControls');
const adminCoinsInputEl = document.getElementById('adminCoins');
const setCoinsBtnEl = document.getElementById('setCoinsBtn');
const adminRankSelectEl = document.getElementById('adminRank');
const setRankBtnEl = document.getElementById('setRankBtn');
const resetLeaderboardBtnEl = document.getElementById('resetLeaderboardBtn');
const hideAdminBtnEl = document.getElementById('hideAdminBtn');
const resetUserCoinsBtnEl = document.getElementById('resetUserCoinsBtn');

/* ---------------- STATE ---------------- */
let username = "";
let coins = 100;
let rank = "None";

/* ---------------- UTILS ---------------- */
function getRankColor(r) {
  if (!r || r === "None") return "#fff";
  if (r === "VIP") return "#f9f37c";   // light yellow
  if (r === "VIP+") return "#f1c40f";  // yellow
  if (r === "VIP++") return "#4819b6"; // purple
  return "#fff";
}

function getOutcomeColor(outcome){
  if(outcome === "Lose" || outcome === "0.5x" || outcome === "0.75x") return "red";
  if(outcome === "5.0x" || outcome === "10x") return "green";
  return "blue";
}

/* ---------------- API ---------------- */
async function fetchLeaderboard(){
  try{
    const res = await fetch(API_URL);
    return await res.json();
  }catch(e){
    console.error("Fetch leaderboard failed", e);
    return [];
  }
}

async function saveUser(){
  if(!username) return;
  try{
    // Check if user exists
    const list = await fetchLeaderboard();
    const existing = list.find(p => p.name === username);
    const payload = { name: username, coins: coins, rank: rank };
    if(existing){
      await fetch(`${API_URL}/${existing.id}`, {
        method:"PUT",
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
    } else {
      await fetch(API_URL, {
        method:"POST",
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
    }
  }catch(e){ console.error("Save user failed", e);}
}

/* ---------------- RENDER ---------------- */
async function renderLeaderboard(){
  const list = await fetchLeaderboard();
  // sort by coins descending
  list.sort((a,b)=> b.coins - a.coins);
  leaderboardUl.innerHTML = "";
  list.forEach((p,i)=>{
    const li = document.createElement('li');
    let col = getRankColor(p.rank);
    li.style.color = col;
    li.textContent = `${i+1}. ${p.name}: ${p.coins} | ${p.rank || "None"}`;
    leaderboardUl.appendChild(li);
  });
  updateUserInfo();
}

/* ---------------- USER INFO ---------------- */
function updateUserInfo(){
  if(!username){
    coinInfo.textContent = "Not logged in";
    coinInfo.style.color = "#fff";
    return;
  }
  coinInfo.textContent = `${username}: ${coins} | ${rank}`;
  coinInfo.style.color = getRankColor(rank);
}

/* ---------------- USERNAME ---------------- */
setUsernameBtnEl.addEventListener('click', async ()=>{
  const val = usernameInputEl.value.trim();
  if(!val){ alert("Enter username"); return; }
  username = val;
  usernameInputEl.disabled = true;
  setUsernameBtnEl.disabled = true;

  // fetch user data from API
  const list = await fetchLeaderboard();
  const existing = list.find(p => p.name === username);
  if(existing){
    coins = Number(existing.coins) || 100;
    rank = existing.rank || "None";
  }else{
    coins = 100;
    rank = "None";
  }
  updateUserInfo();
  await saveUser();
  await renderLeaderboard();
});

/* ---------------- ADMIN ---------------- */
adminBtnEl.addEventListener('click', ()=>{
  if(adminPassEl.value === ADMIN_PASSWORD){
    adminControlsEl.style.display = 'flex';
    adminPassEl.value = '';
    adminCoinsInputEl.value = coins || 100;
    adminRankSelectEl.value = rank || "None";
  }else{
    alert("Incorrect password");
  }
});

setCoinsBtnEl.addEventListener('click', async ()=>{
  if(!username){ alert("Set username first"); return; }
  coins = Math.max(0, Number(adminCoinsInputEl.value) || 0);
  updateUserInfo();
  await saveUser();
  await renderLeaderboard();
});

setRankBtnEl.addEventListener('click', async ()=>{
  if(!username){ alert("Set username first"); return; }
  rank = adminRankSelectEl.value || "None";
  updateUserInfo();
  await saveUser();
  await renderLeaderboard();
});

resetUserCoinsBtnEl.addEventListener('click', async ()=>{
  if(!username){ alert("Set username first"); return; }
  if(confirm("Reset user coins to 100?")){
    coins = 100;
    updateUserInfo();
    await saveUser();
    await renderLeaderboard();
  }
});

resetLeaderboardBtnEl.addEventListener('click', async ()=>{
  if(confirm("Reset leaderboard?")){
    const list = await fetchLeaderboard();
    for(const p of list){
      await fetch(`${API_URL}/${p.id}`, { method:"DELETE" });
    }
    await renderLeaderboard();
  }
});

hideAdminBtnEl.addEventListener('click', ()=>{
  adminControlsEl.style.display = 'none';
});

/* ---------------- POST-SPIN UPDATE ---------------- */
async function afterSpin(result, bet){
  // determine win/loss
  let win = 0;
  if(result !== "Lose"){
    const mult = parseFloat(result.replace("x",""));
    win = Math.floor(bet * mult);
  }
  coins += win;
  if(coins <= 0) coins = 100; // reset if zero
  updateUserInfo();
  await saveUser();
  await renderLeaderboard();
}
  
/* -------- SPIN -------- */
spinBtn.addEventListener('click',()=>{
  if(!username){ alert("Set username first"); return; }
  if(spinning) return;
  let bet=Math.floor(Number(betInput.value)||0);
  if(!bet||bet<=0){ alert("Enter valid bet"); return; }
  if(bet>coins){ alert("Not enough coins"); return; }
  coins = Math.max(0, coins-bet);
  updateUserInfoDisplay();
  spinning=true;
  const idx = Math.floor(Math.random()*N);
  const result=outcomes[idx];
  const currentNorm=((rotationDeg%360)+360)%360;
  const sliceCenterDeg=idx*sliceDeg+sliceDeg/2;
  const baseRotationDeg=(360-sliceCenterDeg)%360;
  const delta=(baseRotationDeg-currentNorm+360)%360;
  const fullSpins=6+Math.floor(Math.random()*5);
  const targetRotation=rotationDeg+fullSpins*360+delta;
  const start=rotationDeg;
  const duration=4200;
  const t0=performance.now();

  function step(t){
    const elapsed=t-t0;
    const p=Math.min(elapsed/duration,1);
    const ease=1-Math.pow(1-p,3);
    rotationDeg=start+(targetRotation-start)*ease;
    drawWheel(rotationDeg);
    if(p<1) requestAnimationFrame(step);
    else {
      rotationDeg=baseRotationDeg+360*Math.floor(rotationDeg/360);
      let win=0;
      if(result!=="Lose"){
        const mult=parseFloat(result.replace("x",""));
        if(!Number.isNaN(mult)) win=Math.floor(bet*mult);
        alert(`üéâ You won ${win} coins! (${result})`);
      } else alert("üò¢ You lost your bet!");
      coins=Math.max(0, coins+win);
      if(coins===0) coins=100; // reset at 0
      updateUserInfoDisplay();
      spinning=false;
    }
  }
  requestAnimationFrame(step);
});

/* -------- LEADERBOARD -------- */
function renderLeaderboard(){
  const ul=document.getElementById('leaderboardList');
  ul.innerHTML="";
  // placeholder for server leaderboard, later second part
}
   /* -------- SERVER CONFIG -------- */
const API_URL = "https://68e839b2f2707e6128ca35e1.mockapi.io/players";

/* -------- SERVER FUNCTIONS -------- */
async function fetchLeaderboard() {
  try {
    const res = await fetch(API_URL);
    const data = await res.json();
    return data; // array of {id, name, coins, rank}
  } catch(e) { console.error("Fetch error:", e); return []; }
}

async function updatePlayerServer(player) {
  try {
    // check if exists
    const board = await fetchLeaderboard();
    const existing = board.find(p => p.name === player.name);
    if(existing) {
      // update existing
      await fetch(`${API_URL}/${existing.id}`, {
        method: "PUT",
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(player)
      });
    } else {
      // create new
      await fetch(API_URL, {
        method: "POST",
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(player)
      });
    }
  } catch(e){ console.error("Update error:", e); }
}

async function renderLeaderboard() {
  const ul = document.getElementById('leaderboardList');
  ul.innerHTML = "";
  let list = await fetchLeaderboard();
  // sort descending coins
  list.sort((a,b)=>b.coins - a.coins);
  list.slice(0,20).forEach((p,i)=>{
    const li=document.createElement('li');
    // rank color
    let color="white";
    if(p.rank==="VIP" || p.rank==="VIP+") color="var(--yellow)";
    else if(p.rank==="VIP++") color="var(--purple)";
    li.style.color=color;
    li.textContent=`${i+1}. ${p.name}: ${p.coins} | ${p.rank || "None"}`;
    ul.appendChild(li);
  });
}

/* -------- SAVE CURRENT USER TO SERVER -------- */
async function saveCurrentToServer() {
  if(!username) return;
  const player = { name: username, coins, rank };
  await updatePlayerServer(player);
  await renderLeaderboard();
}

/* -------- UPDATE USER INFO & SERVER -------- */
function updateUserAndServer(){
  updateUserInfoDisplay();
  saveCurrentToServer();
}

/* -------- OVERRIDE PREVIOUS SAVE FUNCTION -------- */
setUsernameBtn.addEventListener('click', async ()=>{
  const val=usernameInput.value.trim();
  if(!val){ alert("Enter a username"); return; }
  username=val;
  usernameInput.disabled=true; setUsernameBtn.disabled=true;
  coins=100; rank="None";
  updateUserInfoDisplay();
  await saveCurrentToServer();
});

/* -------- SPIN OVERRIDE -------- */
spinBtn.addEventListener('click', async ()=>{
  if(!username){ alert("Set username first"); return; }
  if(spinning) return;
  let bet=Math.floor(Number(betInput.value)||0);
  if(!bet||bet<=0){ alert("Enter valid bet"); return; }
  if(bet>coins){ alert("Not enough coins"); return; }
  coins=Math.max(0, coins-bet);
  updateUserInfoDisplay();
  spinning=true;
  const idx=Math.floor(Math.random()*N);
  const result=outcomes[idx];
  const currentNorm=((rotationDeg%360)+360)%360;
  const sliceCenterDeg=idx*sliceDeg+sliceDeg/2;
  const baseRotationDeg=(360-sliceCenterDeg)%360;
  const delta=(baseRotationDeg-currentNorm+360)%360;
  const fullSpins=6+Math.floor(Math.random()*5);
  const targetRotation=rotationDeg+fullSpins*360+delta;
  const start=rotationDeg;
  const duration=4200;
  const t0=performance.now();

  function step(t){
    const elapsed=t-t0;
    const p=Math.min(elapsed/duration,1);
    const ease=1-Math.pow(1-p,3);
    rotationDeg=start+(targetRotation-start)*ease;
    drawWheel(rotationDeg);
    if(p<1) requestAnimationFrame(step);
    else {
      rotationDeg=baseRotationDeg+360*Math.floor(rotationDeg/360);
      let win=0;
      if(result!=="Lose"){
        const mult=parseFloat(result.replace("x",""));
        if(!Number.isNaN(mult)) win=Math.floor(bet*mult);
        alert(`üéâ You won ${win} coins! (${result})`);
      } else alert("üò¢ You lost your bet!");
      coins=Math.max(0, coins+win);
      if(coins===0) coins=100;
      updateUserAndServer();
      spinning=false;
    }
  }
  requestAnimationFrame(step);
});

/* -------- ADMIN PANEL -------- */
adminBtn.addEventListener('click', ()=>{
  if(adminPass.value==="ghd87"){
    adminControls.style.display='flex';
    adminPass.value='';
    adminCoinsInput.value=coins;
    adminRankSelect.value=rank;
  } else alert("Incorrect password");
});

setCoinsBtn.addEventListener('click', ()=>{
  const v=Math.max(0, Math.floor(Number(adminCoinsInput.value)||0));
  coins=v;
  updateUserAndServer();
  alert("Coins set to "+coins);
});

setRankBtn.addEventListener('click', ()=>{
  const r=adminRankSelect.value || "None";
  rank=r;
  updateUserAndServer();
  alert("Rank set to "+rank);
});

resetUserCoinsBtn.addEventListener('click', ()=>{
  if(!username) return;
  if(confirm("Reset current user's coins to 100?")){
    coins=100;
    updateUserAndServer();
  }
});

resetLeaderboardBtn.addEventListener('click', async ()=>{
  if(confirm("Reset leaderboard?")){
    // Delete all users from server (MockAPI allows DELETE)
    const list=await fetchLeaderboard();
    for(const p of list){
      await fetch(`${API_URL}/${p.id}`,{method:"DELETE"});
    }
    await renderLeaderboard();
    alert("Leaderboard cleared");
  }
});

hideAdminBtn.addEventListener('click', ()=>{ adminControls.style.display='none'; });

/* -------- INIT -------- */
renderLeaderboard();
updateUserInfoDisplay();
  
</script>
</body>
</html>
